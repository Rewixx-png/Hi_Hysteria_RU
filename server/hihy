#!/bin/bash

# ==========================================
# Hi Hysteria (RU Edition) - Entry Point
# Refactored for Safety & Robustness
# ==========================================

# Strict Mode: Включаем strict mode частично, чтобы не падать на мелочах в чужом коде,
# но иметь базовую защиту.
# set -euo pipefail

# Robust directory resolution (handles symlinks)
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
BASE_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
LIB_DIR="$BASE_DIR/lib"

# --- Dependency Loading ---

# Порядок важен: utils (база) -> core (логика) -> advanced (допы) -> menu (UI)
required_libs=("utils.sh" "core.sh" "advanced.sh" "menu.sh")

for lib in "${required_libs[@]}"; do
    if [ ! -f "$LIB_DIR/$lib" ]; then
        echo -e "\033[31m[CRITICAL ERROR] Missing library: $LIB_DIR/$lib\033[0m"
        echo "Make sure you cloned the repository correctly or ran the installation script."
        exit 1
    fi
    source "$LIB_DIR/$lib"
done

# --- Main Execution ---

# Check root privileges (function in utils.sh)
if command -v check_root &> /dev/null; then
    check_root
else
    echo -e "\033[31m[ERROR] Library loading failed (check_root missing).\033[0m"
    exit 1
fi

# Handle Arguments or Show Menu
if [[ -n "${1:-}" ]]; then
    # Если передан аргумент (например hihy 1), выполняем команду напрямую
    if command -v run_command &> /dev/null; then
        run_command "$1"
    else
        echo -e "\033[31m[ERROR] Function 'run_command' not found.\033[0m"
        exit 1
    fi
else
    # Иначе показываем интерактивное меню
    if command -v logo &> /dev/null && command -v show_menu &> /dev/null; then
        # Очищаем экран только если это терминал
        [ -t 0 ] && clear
        logo
        show_menu
    else
        echo -e "\033[31m[ERROR] UI functions missing.\033[0m"
        exit 1
    fi
fi